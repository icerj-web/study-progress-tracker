<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Study Tracker - Admin & User Role Management</title>
<style>
  body {
    font-family: Arial, sans-serif; background: #f5f7fa; margin: 0; min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px;
  }
  .container {
    background: white;
    padding: 25px 30px;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(0,0,0,0.1);
    max-width: 600px;
    width: 100%;
  }
  h2 {
    color: #004aad;
    margin-top: 0;
  }
  input[type=text], input[type=password], textarea {
    width: 100%;
    padding: 10px 12px;
    margin: 6px 0 14px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 16px;
    resize: vertical;
  }
  button {
    background: #004aad;
    color: white;
    border: none;
    padding: 12px;
    font-weight: 700;
    font-size: 16px;
    border-radius: 8px;
    cursor: pointer;
    margin-top: 8px;
    width: 100%;
  }
  button:hover {
    background: #00337f;
  }
  .switch-auth {
    margin-top: 15px;
    color: #004aad;
    cursor: pointer;
    text-decoration: underline;
  }
  #logout-btn, #delete-account-btn, #admin-logout-btn {
    background: #e53935;
    width: auto;
    padding: 8px 16px;
    margin: 10px 4px 0 0;
  }
  #logout-btn:hover, #delete-account-btn:hover, #admin-logout-btn:hover {
    background: #ab000d;
  }
  #welcome-msg, #admin-welcome-msg {
    font-weight: 600;
    margin-bottom: 20px;
    color: #333;
  }
  .hidden {
    display: none !important;
  }
  /* Autocomplete styling */
  .autocomplete-items {
    position: absolute;
    border: 1px solid #ddd;
    border-bottom: none;
    border-top: none;
    z-index: 99;
    top: 100%;
    left: 0;
    right: 0;
    background:white;
  }
  .autocomplete-items div {
    padding: 10px;
    cursor: pointer;
  }
  .autocomplete-items div:hover {
    background-color: #e9e9e9;
  }
  .role-item {
    border-bottom: 1px solid #ddd;
    padding: 8px 4px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
  }
  .role-item:last-child {
    border-bottom: none;
  }
  .role-add-btn {
    background: #004aad;
    color: white;
    border: none;
    padding: 4px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
  }
  .role-add-btn:hover {
    background: #00337f;
  }
  .personal-role {
    background: #f0f8ff;
    padding: 8px 10px;
    margin: 6px 0;
    border-radius: 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .remove-btn {
    background: #e53935;
    color: white;
    border: none;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    font-weight: 900;
    cursor: pointer;
  }
</style>
</head>
<body>

<div class="container" id="auth-container">
  <h2 id="form-title">Login</h2>
  <input type="text" id="username" placeholder="Username" autocomplete="username" />
  <input type="password" id="password" placeholder="Password" autocomplete="current-password" />
  <button id="submit-btn">Login</button>
  <div class="switch-auth" id="toggle-auth">Don't have an account? Sign up</div>
</div>

<div class="container hidden" id="user-container">
  <div id="welcome-msg"></div>
  <button id="logout-btn">Logout</button>
  <button id="delete-account-btn">Delete Account</button>

  <h3>Add Roles to Your Learning List</h3>
  <div style="position: relative;">
    <input type="text" id="role-search" placeholder="Search roles..." autocomplete="off" />
    <div id="autocomplete-list" class="autocomplete-items"></div>
  </div>

  <h3>Your Roles</h3>
  <div id="personal-role-list"><p>No roles added yet.</p></div>
</div>

<div class="container hidden" id="admin-container">
  <div id="admin-welcome-msg"></div>
  <button id="admin-logout-btn">Logout</button>

  <h3>Master Role Management</h3>
  <div id="master-roles-list"></div>

  <h4>Add New Master Role</h4>
  <input type="text" id="new-role-title" placeholder="Role title" />
  <textarea id="new-role-desc" placeholder="Role description"></textarea>
  <button id="add-master-role-btn">Add Role</button>
</div>

<script>
  // Predefined admin user credentials
  const ADMIN_USERNAME = "admin";
  const ADMIN_PASSWORD_HASH = hashPassword("MyNewPass@2025");

  // Load users and ensure admin user is present with correct password hash (fixed loadUsers function)
  function loadUsers() {
    let stored = localStorage.getItem("users");
    let users;
    if (!stored) {
      // No users saved yet, initialize with admin
      users = {
        [ADMIN_USERNAME]: { password: ADMIN_PASSWORD_HASH, data: { roles: [] } }
      };
      localStorage.setItem("users", JSON.stringify(users));
    } else {
      users = JSON.parse(stored);
      // Add or update admin user to ensure correct password
      if (!users[ADMIN_USERNAME] || users[ADMIN_USERNAME].password !== ADMIN_PASSWORD_HASH) {
        users[ADMIN_USERNAME] = { password: ADMIN_PASSWORD_HASH, data: { roles: [] } };
        localStorage.setItem("users", JSON.stringify(users));
      }
    }
    return users;
  }

  function loadMasterRoles() {
    let stored = localStorage.getItem("masterRoles");
    if (!stored) {
      const initialMasterRoles = [
        { id: "devops", title: "DevOps Engineer", description: "Role covering Azure, AWS, Terraform, Docker, Kubernetes, CI/CD, Monitoring and more."},
        { id: "infrastructure", title: "Infrastructure Engineer", description: "Server, virtualization, cloud infrastructure, networking, backup and automation."},
        { id: "noc", title: "Network Operations Center Engineer", description: "Monitoring via CloudWatch, SolarWinds, incident handling and escalation."}
      ];
      localStorage.setItem("masterRoles", JSON.stringify(initialMasterRoles));
      return initialMasterRoles;
    }
    return JSON.parse(stored);
  }

  function saveUsers(users) {
    localStorage.setItem("users", JSON.stringify(users));
  }

  function saveMasterRoles(masterRoles) {
    localStorage.setItem("masterRoles", JSON.stringify(masterRoles));
  }

  function hashPassword(str) {
    let hash = 0, i, chr;
    if (str.length ===0) return hash.toString();
    for(i=0;i<str.length;i++){
      chr = str.charCodeAt(i);
      hash = ((hash << 5) - hash) + chr;
      hash |=0;
    }
    return hash.toString();
  }

  // App State
  let users = loadUsers();
  let masterRoles = loadMasterRoles();
  let currentUser = null;
  let isLogin = true;

  // DOM Elements
  const authContainer = document.getElementById("auth-container");
  const userContainer = document.getElementById("user-container");
  const adminContainer = document.getElementById("admin-container");

  const usernameInput = document.getElementById("username");
  const passwordInput = document.getElementById("password");
  const submitBtn = document.getElementById("submit-btn");
  const toggleAuth = document.getElementById("toggle-auth");

  const welcomeMsg = document.getElementById("welcome-msg");
  const logoutBtn = document.getElementById("logout-btn");
  const deleteAccountBtn = document.getElementById("delete-account-btn");

  const adminWelcomeMsg = document.getElementById("admin-welcome-msg");
  const adminLogoutBtn = document.getElementById("admin-logout-btn");

  const roleSearchInput = document.getElementById("role-search");
  const autocompleteList = document.getElementById("autocomplete-list");
  const personalRoleList = document.getElementById("personal-role-list");

  const masterRolesList = document.getElementById("master-roles-list");
  const newRoleTitleInput = document.getElementById("new-role-title");
  const newRoleDescInput = document.getElementById("new-role-desc");
  const addMasterRoleBtn = document.getElementById("add-master-role-btn");

  const formTitle = document.getElementById("form-title");

  // Toggle login/signup UI
  toggleAuth.addEventListener("click", () => {
    isLogin = !isLogin;
    formTitle.textContent = isLogin ? "Login" : "Sign Up";
    submitBtn.textContent = isLogin ? "Login" : "Sign Up";
    toggleAuth.textContent = isLogin ? "Don't have an account? Sign up" : "Already have an account? Login";
    usernameInput.value = "";
    passwordInput.value = "";
  });

  // Submit login or signup
  submitBtn.addEventListener("click", () => {
    const username = usernameInput.value.trim();
    const password = passwordInput.value.trim();
    if (!username || !password) {
      alert("Enter username and password");
      return;
    }
    if (isLogin) {
      if (users[username] && users[username].password === hashPassword(password)) {
        currentUser = username;
        sessionStorage.setItem("currentUser", currentUser);
        showAppropriateDashboard();
      } else {
        alert("Invalid username or password");
      }
    } else {
      if (users[username]) {
        alert("Username already exists");
        return;
      }
      users[username] = { password: hashPassword(password), data: { roles: [] } };
      saveUsers(users);
      alert("User created! Please login.");
      isLogin = true;
      formTitle.textContent = "Login";
      submitBtn.textContent = "Login";
      toggleAuth.textContent = "Don't have an account? Sign up";
      usernameInput.value = "";
      passwordInput.value = "";
    }
  });

  // Show user or admin dashboard after login
  function showAppropriateDashboard() {
    authContainer.classList.add("hidden");
    if (currentUser === "admin") {
      showAdminDashboard();
    } else {
      showUserDashboard();
    }
  }

  // Show admin dashboard
  function showAdminDashboard() {
    userContainer.classList.add("hidden");
    adminContainer.classList.remove("hidden");
    adminWelcomeMsg.textContent = `Welcome, Admin!`;
    renderMasterRoles();
  }

  // Show user dashboard
  function showUserDashboard() {
    adminContainer.classList.add("hidden");
    userContainer.classList.remove("hidden");
    welcomeMsg.textContent = `Welcome, ${currentUser}!`;
    roleSearchInput.value = "";
    renderPersonalRoles();
    autocompleteList.innerHTML = "";
  }

  // Logout handlers
  logoutBtn.addEventListener("click", () => {
    currentUser = null;
    sessionStorage.removeItem("currentUser");
    userContainer.classList.add("hidden");
    authContainer.classList.remove("hidden");
    usernameInput.value = "";
    passwordInput.value = "";
  });
  adminLogoutBtn.addEventListener("click", () => {
    currentUser = null;
    sessionStorage.removeItem("currentUser");
    adminContainer.classList.add("hidden");
    authContainer.classList.remove("hidden");
    usernameInput.value = "";
    passwordInput.value = "";
  });

  // Delete account for regular user
  deleteAccountBtn.addEventListener("click", () => {
    if (confirm("Delete your account? This cannot be undone.")) {
      delete users[currentUser];
      saveUsers(users);
      logoutBtn.click();
      alert("Account deleted");
    }
  });

  // Render master roles in admin dashboard
  function renderMasterRoles() {
    masterRolesList.innerHTML = "";
    masterRoles.forEach((role, idx) => {
      const div = document.createElement("div");
      div.style.border = "1px solid #ddd";
      div.style.padding = "10px";
      div.style.marginBottom = "10px";
      div.style.borderRadius = "8px";

      const title = document.createElement("h4");
      title.textContent = role.title;
      div.appendChild(title);

      const desc = document.createElement("p");
      desc.textContent = role.description || "";
      div.appendChild(desc);

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "Delete Role";
      deleteBtn.style.background = "#e53935";
      deleteBtn.style.color = "white";
      deleteBtn.style.border = "none";
      deleteBtn.style.padding = "6px 12px";
      deleteBtn.style.borderRadius = "6px";
      deleteBtn.style.cursor = "pointer";

      deleteBtn.addEventListener("click", () => {
        if (confirm(`Delete master role: ${role.title}?`)) {
          masterRoles.splice(idx, 1);
          saveMasterRoles(masterRoles);
          renderMasterRoles();
        }
      });

      div.appendChild(deleteBtn);

      masterRolesList.appendChild(div);
    });
  }

  // Admin add new master role
  addMasterRoleBtn.addEventListener("click", () => {
    const title = newRoleTitleInput.value.trim();
    const desc = newRoleDescInput.value.trim();
    if (!title) {
      alert("Role title is required");
      return;
    }
    if (masterRoles.some(r => r.title.toLowerCase() === title.toLowerCase())) {
      alert("Role already exists");
      return;
    }
    masterRoles.push({ id: `role-${Date.now()}`, title, description: desc });
    saveMasterRoles(masterRoles);
    newRoleTitleInput.value = "";
    newRoleDescInput.value = "";
    renderMasterRoles();
  });

  // User: Role search autocomplete UI
  roleSearchInput.addEventListener("input", () => {
    const val = roleSearchInput.value.trim().toLowerCase();
    autocompleteList.innerHTML = "";
    if (!val) return;

    const filtered = masterRoles.filter(r => r.title.toLowerCase().includes(val));
    filtered.forEach(role => {
      const item = document.createElement("div");
      item.className = "role-item";
      item.textContent = role.title;

      const addBtn = document.createElement("button");
      addBtn.textContent = "Add";
      addBtn.className = "role-add-btn";
      addBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        addRoleToUser(role);
      });

      item.appendChild(addBtn);
      autocompleteList.appendChild(item);

      item.addEventListener("click", () => {
        roleSearchInput.value = role.title;
        autocompleteList.innerHTML = "";
      });
    });
  });

  // Add role to user personal roles
  function addRoleToUser(role) {
    const userData = users[currentUser].data;
    userData.roles = userData.roles || [];
    if (userData.roles.some(r => r.title === role.title)) {
      alert("Role already added");
      return;
    }
    // Add role with empty roadmap to personal list for now
    userData.roles.push({ title: role.title, description: role.description || "", roadmap: [] });
    saveUsers(users);
    alert(`Role "${role.title}" added to your list!`);
    renderPersonalRoles();
    roleSearchInput.value = "";
    autocompleteList.innerHTML = "";
  }

  // Render personal roles list for user
  function renderPersonalRoles() {
    const userData = users[currentUser].data;
    const roles = userData.roles || [];
    personalRoleList.innerHTML = "";
    if (roles.length === 0) {
      personalRoleList.innerHTML = "<p>No roles added yet. Use the search box above to add roles.</p>";
      return;
    }
    roles.forEach((role, i) => {
      const div = document.createElement("div");
      div.className = "personal-role";
      div.textContent = role.title;

      const removeBtn = document.createElement("button");
      removeBtn.className = "remove-btn";
      removeBtn.title = `Remove ${role.title}`;
      removeBtn.textContent = "Ã—";

      removeBtn.addEventListener("click", () => {
        if (confirm(`Remove role: ${role.title}?`)) {
          roles.splice(i, 1);
          saveUsers(users);
          renderPersonalRoles();
        }
      });

      div.appendChild(removeBtn);
      personalRoleList.appendChild(div);
    });
  }

  // On page load, check session and show proper UI
  window.onload = () => {
    const savedUser = sessionStorage.getItem("currentUser");
    if(savedUser && users[savedUser]) {
      currentUser = savedUser;
      showAppropriateDashboard();
    }
  };
</script>

</body>
</html>
