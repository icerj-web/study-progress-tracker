<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Study Tracker with Local User Auth</title>
<style>
  body {
    font-family: Arial, sans-serif; background: #f5f7fa; margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; height: 100vh;
  }
  .container {
    background: white; padding: 20px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); max-width: 400px; width: 100%;
  }
  h2 {
    color: #004aad; margin-bottom: 16px;
  }
  input[type=text], input[type=password] {
    width: 100%; padding: 10px; margin: 10px 0; border-radius: 6px; border: 1px solid #ccc; font-size: 16px;
  }
  button {
    background: #004aad; color: white; border: none; padding: 12px 20px; width: 100%; cursor: pointer; border-radius: 6px; font-weight: 700; font-size: 16px;
  }
  button:hover {
    background: #00337f;
  }
  .switch {
    margin-top: 12px;
    font-size: 14px;
    cursor: pointer;
    color: #004aad;
    text-decoration: underline;
  }
  #app {
    display: none;
  }
  #logout-btn {
    background: #e53935; width: auto; padding: 6px 14px; margin-bottom: 12px;
  }
</style>
</head>
<body>

<div class="container">
  
  <div id="auth-section">
    <h2 id="auth-title">Login</h2>
    <input type="text" id="username" placeholder="Username" autocomplete="username" />
    <input type="password" id="password" placeholder="Password" autocomplete="current-password" />
    <button id="auth-btn">Login</button>
    <div class="switch" id="switch-auth">Don't have an account? Sign up here</div>
  </div>

  <div id="app">
    <button id="logout-btn">Logout</button>
    <h2>Welcome, <span id="welcome-user"></span>!</h2>

    <h3>Select Your Role</h3>
    <div id="role-selection"></div>

    <form id="add-role-form" aria-label="Add New Role Form">
      <input type="text" id="new-role-input" placeholder="Add new role title" />
      <button type="submit">Add Role</button>
    </form>

    <div id="role-progress"></div>

    <div id="dashboard" style="margin-top: 15px; display:none;">
      <h3 id="role-title"></h3>
      <button id="back-to-roles">&#8592; Back to Roles</button>
      <div id="topic-list" style="margin-top:15px;"></div>
    </div>
  </div>

</div>

<script>
  // User 'database' in localStorage - username: {password, data}
  let users = JSON.parse(localStorage.getItem("users") || "{}");

  let currentUser = null;

  const authTitle = document.getElementById("auth-title");
  const usernameInput = document.getElementById("username");
  const passwordInput = document.getElementById("password");
  const authBtn = document.getElementById("auth-btn");
  const switchAuth = document.getElementById("switch-auth");

  const authSection = document.getElementById("auth-section");
  const appSection = document.getElementById("app");
  const logoutBtn = document.getElementById("logout-btn");
  const welcomeUser = document.getElementById("welcome-user");

  const roleSelectionEl = document.getElementById("role-selection");
  const addRoleForm = document.getElementById("add-role-form");
  const newRoleInput = document.getElementById("new-role-input");

  const dashboardEl = document.getElementById("dashboard");
  const backToRolesBtn = document.getElementById("back-to-roles");
  const roleTitleEl = document.getElementById("role-title");
  const topicListEl = document.getElementById("topic-list");
  const roleProgressEl = document.getElementById("role-progress");

  let selectedRoleIndex = null;

  // Toggle between login and signup mode
  let isLogin = true;
  switchAuth.onclick = () => {
    isLogin = !isLogin;
    authTitle.textContent = isLogin ? "Login" : "Sign Up";
    authBtn.textContent = isLogin ? "Login" : "Sign Up";
    switchAuth.textContent = isLogin ? "Don't have an account? Sign up here" : "Already have an account? Login here";
  };

  // Hash simple (for demo only)
  function simpleHash(str) {
    let hash = 0;
    for(let i=0; i<str.length; i++) {
      hash = ((hash << 5) - hash) + str.charCodeAt(i);
      hash |= 0;
    }
    return hash.toString();
  }

  // Auth button click handler
  authBtn.onclick = () => {
    const user = usernameInput.value.trim();
    const pass = passwordInput.value.trim();
    if(!user || !pass) {
      alert("Please enter username and password");
      return;
    }
    if(isLogin) {
      // Login
      if(users[user] && users[user].password === simpleHash(pass)) {
        currentUser = user;
        startupForUser(user);
      } else {
        alert("Invalid username or password");
      }
    } else {
      // Signup
      if(users[user]) {
        alert("Username already exists");
        return;
      }
      users[user] = { password: simpleHash(pass), data: {roles:[]} };
      localStorage.setItem("users", JSON.stringify(users));
      alert("Signup successful! Please login.");
      isLogin = true;
      authTitle.textContent = "Login";
      authBtn.textContent = "Login";
      switchAuth.textContent = "Don't have an account? Sign up here";
      usernameInput.value = "";
      passwordInput.value = "";
    }
  };

  // Start app for logged in user
  function startupForUser(user) {
    authSection.style.display = "none";
    appSection.style.display = "block";
    logoutBtn.style.display = "inline-block";
    welcomeUser.textContent = user;
    loadUserRoles();
  }

  // Load roles from user data
  function loadUserRoles() {
    const data = users[currentUser].data;
    if(!data.roles) data.roles = [];
    renderRoles(data.roles);
    dashboardEl.style.display = "none";
    selectedRoleIndex = null;
    roleProgressEl.textContent = "";
  }

  // Render roles for user
  function renderRoles(roles) {
    roleSelectionEl.innerHTML = "";
    if(roles.length === 0) {
      roleSelectionEl.innerHTML = "<p>No roles added yet.</p>";
      return;
    }
    roles.forEach((role, idx) => {
      const div = document.createElement("div");
      div.textContent = role.title;
      div.style.padding = "10px 15px";
      div.style.border = "1px solid #ddd";
      div.style.margin = "8px 0";
      div.style.borderRadius = "6px";
      div.style.cursor = "pointer";
      div.style.background = "#f0f8ff";
      div.addEventListener("click", () => {
        showDashboard(idx);
      });
      roleSelectionEl.appendChild(div);
    });
  }

  // Show dashboard for selected role
  function showDashboard(idx) {
    selectedRoleIndex = idx;
    const role = users[currentUser].data.roles[idx];
    dashboardEl.style.display = "block";
    roleTitleEl.textContent = role.title;
    renderProgress(role);
    renderTopics(role);
    roleProgressEl.textContent = "";
    roleSelectionEl.style.display = "none";
    addRoleForm.style.display = "none";
  }

  // Render overall progress % for role
  function renderProgress(role) {
    const totalTopics = role.roadmap ? role.roadmap.length : 0;
    if (totalTopics === 0) {
      roleProgressEl.textContent = "";
      return;
    }
    const finishedCount = role.roadmap.filter(t => t.status === "Finished").length;
    const percent = Math.round((finishedCount / totalTopics) * 100);
    roleProgressEl.innerHTML = `<strong>Progress:</strong> ${percent}% completed`;
  }

  // Render topics list for selected role
  function renderTopics(role) {
    topicListEl.innerHTML = "";
    if (!role.roadmap || role.roadmap.length === 0) {
      topicListEl.innerHTML = "<p>No topics found for this role yet.</p>";
      return;
    }
    role.roadmap.forEach((topic, i) => {
      const div = document.createElement("div");
      div.textContent = topic.topic + " - " + topic.status;
      div.style.padding = "8px";
      div.style.borderBottom = "1px solid #eee";
      div.style.cursor = "pointer";
      div.addEventListener("click", () => {
        alert(`Show detailed topic tracking view here for: ${topic.topic}\nYou can extend this to edit Status, Description etc.`);
      });
      topicListEl.appendChild(div);
    });
  }

  // Add Role form submission
  addRoleForm.addEventListener("submit", e => {
    e.preventDefault();
    const newRole = newRoleInput.value.trim();
    if(!newRole) {
      alert("Please enter a role title");
      return;
    }
    const data = users[currentUser].data;
    data.roles = data.roles || [];
    // Prevent duplicate role
    if(data.roles.some(r => r.title.toLowerCase() === newRole.toLowerCase())) {
      alert("This role already exists.");
      return;
    }
    data.roles.push({ title: newRole, roadmap: [] });
    users[currentUser].data = data;
    localStorage.setItem("users", JSON.stringify(users));
    newRoleInput.value = "";
    renderRoles(data.roles);
  });

  // Logout button
  logoutBtn.addEventListener("click", () => {
    currentUser = null;
    authSection.style.display = "block";
    appSection.style.display = "none";
    usernameInput.value = "";
    passwordInput.value = "";
    roleSelectionEl.style.display = "block";
    addRoleForm.style.display = "block";
  });

  // Check if already logged in (sessionStorage)
  window.onload = () => {
    let savedUser = sessionStorage.getItem("loggedInUser");
    if(savedUser && users[savedUser]) {
      currentUser = savedUser;
      startupForUser(savedUser);
    }
  };

  // Save current user to sessionStorage on login
  function saveCurrentUserSession(username) {
    sessionStorage.setItem("loggedInUser", username);
  }

  // After login
  authBtn.onclick = () => {
    const user = usernameInput.value.trim();
    const pass = passwordInput.value.trim();
    if(!user || !pass) {
      alert("Please enter username and password");
      return;
    }
    if(isLogin) {
      if(users[user] && users[user].password === simpleHash(pass)) {
        currentUser = user;
        saveCurrentUserSession(user);
        startupForUser(user);
      } else {
        alert("Invalid username or password");
      }
    } else {
      if(users[user]) {
        alert("Username already exists");
        return;
      }
      users[user] = { password: simpleHash(pass), data: {roles:[]} };
      localStorage.setItem("users", JSON.stringify(users));
      alert("Signup successful! Please login.");
      isLogin = true;
      authTitle.textContent = "Login";
      authBtn.textContent = "Login";
      switchAuth.textContent = "Don't have an account? Sign up here";
      usernameInput.value = "";
      passwordInput.value = "";
    }
  };

  // Hash function for simplicity
  function simpleHash(str) {
    let hash = 0;
    for(let i=0;i<str.length;i++) {
      hash = ((hash << 5) - hash) + str.charCodeAt(i);
      hash |= 0;
    }
    return hash.toString();
  }
</script>

</body>
</html>
