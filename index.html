<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Study Tracker - Full Admin & User Roadmap with Progress</title>
<style>
  body {
    font-family: Arial, sans-serif; background:#f5f7fa; margin:0; min-height:100vh; padding:20px; display:flex; justify-content:center; align-items:flex-start;
  }
  .container {
    background: white; padding: 25px 30px; border-radius: 12px; box-shadow: 0 0 20px rgba(0,0,0,0.1); max-width: 900px; width: 100%; margin-bottom: 40px;
  }
  h2, h3, h4 {
    color: #004aad; margin: 0 0 15px 0;
  }
  input[type=text], input[type=password], textarea, select, input[type=date], input[type=datetime-local] {
    width: 100%; padding:10px 12px; margin:6px 0 12px; border-radius:8px; border:1px solid #ccc; font-size: 16px; resize: vertical;
  }
  button {
    background: #004aad; color:white; border:none; padding:12px; font-weight:700; font-size:16px; border-radius:8px; cursor:pointer; margin-top:8px; width: 100%;
  }
  button:hover {background:#00337f}
  .switch-auth {
    margin-top: 15px; color:#004aad; cursor:pointer; text-decoration:underline;
  }
  #logout-btn, #delete-account-btn, #admin-logout-btn {
    background:#e53935; width:auto; padding:8px 16px; margin: 10px 4px 0 0;
  }
  #logout-btn:hover, #delete-account-btn:hover, #admin-logout-btn:hover {
    background:#ab000d;
  }
  #welcome-msg, #admin-welcome-msg {
    font-weight: 600; margin-bottom: 20px; color: #333;
  }
  .hidden {display:none !important;}
  .autocomplete-items {
    position: absolute; border: 1px solid #ddd; border-bottom: none; border-top: none; z-index: 99; top: 100%; left: 0; right: 0; background:white;
  }
  .autocomplete-items div {padding:10px; cursor:pointer;}
  .autocomplete-items div:hover {background-color:#e9e9e9;}
  .role-item {
    border-bottom: 1px solid #ddd; padding: 8px 4px; cursor:pointer; display: flex; justify-content: space-between;
  }
  .role-item:last-child {border-bottom:none;}
  .role-add-btn {
    background:#004aad; color:white; border:none; padding: 4px 10px; border-radius:6px; cursor:pointer; font-size:14px;
  }
  .role-add-btn:hover {background:#00337f;}
  .personal-role {
    background:#f0f8ff; padding:8px 10px; margin:6px 0; border-radius:6px; display:flex; justify-content:space-between; align-items:center; cursor:pointer;
  }
  .remove-btn {
    background:#e53935; color:white; border:none; border-radius:50%; width:22px; height:22px; font-weight:900; cursor:pointer; margin-left:8px;
  }
  #role-details-container, #topic-editor-container, #subtopic-editor-container, #study-session-container {
    max-width: 900px; background: white; padding: 20px 25px; border-radius: 12px; box-shadow: 0 0 20px rgba(0,0,0,0.1); margin-top: 20px;
  }
  #back-to-roles-btn, #back-to-topics-btn, #back-to-subtopics-btn {
    background:#004aad; color:white; border:none; border-radius:6px; padding:10px 18px; cursor:pointer; margin-bottom: 15px; width: auto;
  }
  #back-to-roles-btn:hover, #back-to-topics-btn:hover, #back-to-subtopics-btn:hover {
    background:#00337f;
  }
  .topic-list, .topic-item, .subtopic-list, .subtopic-item {
    list-style: none; padding-left: 0;
  }
  .topic-item, .subtopic-item {
    padding: 8px 8px; border-bottom: 1px solid #ddd; cursor:pointer; display:flex; justify-content: space-between; align-items: center;
  }
  .topic-item:hover, .subtopic-item:hover {
    background:#eef6ff;
  }
  .progress-bar {
    width: 100%; height: 15px; background: #ddd; border-radius: 8px; overflow: hidden; margin-top: 6px;
  }
  .progress-fill {
    height: 100%; background: #004aad; width: 0; transition: width 0.4s ease;
  }
  .status-label {
    font-weight: 700; font-size: 0.9rem; padding: 4px 8px; border-radius: 8px; color: white; user-select:none;
  }
  .status-pending { background: #f59e0b; }
  .status-inprogress { background: #3b82f6; }
  .status-finished { background: #10b981; }
  label { font-weight: 600; display: block; margin-top: 12px; }
  small { color: #555; }
</style>
</head>
<body>

<div class="container" id="auth-container">
  <h2 id="form-title">Login</h2>
  <input type="text" id="username" placeholder="Username" autocomplete="username" />
  <input type="password" id="password" placeholder="Password" autocomplete="current-password" />
  <button id="submit-btn">Login</button>
  <div class="switch-auth" id="toggle-auth">Don't have an account? Sign up</div>
</div>

<!-- User Dashboard -->
<div class="container hidden" id="user-container">
  <div id="welcome-msg"></div>
  <button id="logout-btn">Logout</button>
  <button id="delete-account-btn">Delete Account</button>

  <h3>Add Roles to Your Learning List</h3>
  <div style="position: relative;">
    <input type="text" id="role-search" placeholder="Search roles..." autocomplete="off" />
    <div id="autocomplete-list" class="autocomplete-items"></div>
  </div>

  <h3>Your Roles</h3>
  <div id="personal-role-list"><p>No roles added yet.</p></div>
</div>

<!-- Admin Dashboard -->
<div class="container hidden" id="admin-container">
  <div id="admin-welcome-msg"></div>
  <button id="admin-logout-btn">Logout</button>

  <h3>User Management</h3>
  <div id="admin-user-list"></div>

  <h3>Master Role Management</h3>
  <div id="master-roles-list"></div>

  <h4>Add New Master Role</h4>
  <input type="text" id="new-role-title" placeholder="Role title" />
  <textarea id="new-role-desc" placeholder="Role description"></textarea>
  <button id="add-master-role-btn">Add Role</button>
</div>

<!-- Role Details View -->
<div class="container hidden" id="role-details-container">
  <button id="back-to-roles-btn">← Back to Roles</button>
  <h3 id="role-detail-title"></h3>
  <p id="role-detail-desc"></p>

  <h4>Topics</h4>
  <ul id="role-topics-list" class="topic-list"></ul>

  <div class="progress-bar" aria-label="Overall Role Progress">
    <div class="progress-fill" id="role-progress-bar"></div>
  </div>
  <small id="role-progress-percent"></small>
</div>

<!-- Topic Editor for Admin -->
<div class="container hidden" id="topic-editor-container">
  <button id="back-to-topics-btn">← Back to Roles</button>
  <h3>Edit Topics for <span id="topic-role-title"></span></h3>

  <ul id="admin-topic-list"></ul>

  <h4>Add New Topic</h4>
  <input type="text" id="new-topic-title" placeholder="Topic title" />
  <select id="new-topic-status" style="width:100%; margin-bottom:12px;">
    <option value="Pending">Pending</option>
    <option value="In Progress">In Progress</option>
    <option value="Finished">Finished</option>
  </select>
  <input type="date" id="new-topic-deadline" placeholder="Deadline" />
  <textarea id="new-topic-desc" placeholder="Topic description (optional)"></textarea>
  <button id="add-topic-btn">Add Topic</button>
</div>

<!-- Subtopic Editor for Admin -->
<div class="container hidden" id="subtopic-editor-container">
  <button id="back-to-subtopics-btn">← Back to Topics</button>
  <h3>Edit Subtopics for <span id="subtopic-topic-title"></span></h3>

  <ul id="admin-subtopic-list"></ul>

  <h4>Add New Subtopic</h4>
  <input type="text" id="new-subtopic-title" placeholder="Subtopic title" />
  <select id="new-subtopic-status" style="width:100%; margin-bottom:12px;">
    <option value="Pending">Pending</option>
    <option value="In Progress">In Progress</option>
    <option value="Finished">Finished</option>
  </select>
  <input type="date" id="new-subtopic-deadline" placeholder="Deadline" />
  <textarea id="new-subtopic-desc" placeholder="Subtopic description (optional)"></textarea>
  <button id="add-subtopic-btn">Add Subtopic</button>
</div>

<!-- Study Sessions for User -->
<div class="container hidden" id="study-session-container">
  <button id="back-to-subtopics-from-session-btn">← Back to Subtopics</button>
  <h3>Study Sessions for <span id="session-subtopic-title"></span></h3>

  <ul id="user-study-sessions-list"></ul>

  <h4>Add Study Session</h4>
  <label>Start Date & Time:</label>
  <input type="datetime-local" id="session-start"/>
  <label>End Date & Time:</label>
  <input type="datetime-local" id="session-end"/>
  <textarea id="session-notes" placeholder="Session notes"></textarea>
  <button id="add-session-btn">Add Session</button>
</div>

<script>
  //-- Utility Functions --//
  function hashPassword(str) {
    let hash = 0, i, chr;
    if (str.length === 0) return hash.toString();
    for (i = 0; i < str.length; i++) {
      chr = str.charCodeAt(i);
      hash = ((hash << 5) - hash) + chr;
      hash |= 0;
    }
    return hash.toString();
  }
  function formatDate(dateStr) {
    if (!dateStr) return "";
    const d = new Date(dateStr);
    if (isNaN(d)) return "";
    return d.toLocaleDateString() + (dateStr.includes("T") ? " " + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "");
  }
  function calculateProgress(items) {
    if (!items || !items.length) return 0;
    let done = items.filter(i => i.status && i.status.toLowerCase() === "finished").length;
    return Math.round(done / items.length * 100);
  }
  
  //-- Load/Save Data --//
  const ADMIN_USERNAME = "vaish";
  const ADMIN_PASSWORD_HASH = hashPassword("123456");
  let users = JSON.parse(localStorage.getItem("users")) || { };
  let masterRoles = JSON.parse(localStorage.getItem("masterRoles")) || [];

  function saveUsers() {
    localStorage.setItem("users", JSON.stringify(users));
  }
  function saveMasterRoles() {
    localStorage.setItem("masterRoles", JSON.stringify(masterRoles));
  }

  //-- Ensure admin user exists --
  if (!users[ADMIN_USERNAME] || users[ADMIN_USERNAME].password !== ADMIN_PASSWORD_HASH) {
    users[ADMIN_USERNAME] = { password: ADMIN_PASSWORD_HASH, data: { roles: [] } };
    saveUsers();
  }

  //-- State Variables --//
  let currentUser = null;
  let isLogin = true;
  let selectedRoleIndex = null;
  let selectedTopicIndex = null;

  //-- Elements --//
  const authContainer = document.getElementById("auth-container");
  const userContainer = document.getElementById("user-container");
  const adminContainer = document.getElementById("admin-container");
  const roleDetailsContainer = document.getElementById("role-details-container");
  const topicEditorContainer = document.getElementById("topic-editor-container");
  const subtopicEditorContainer = document.getElementById("subtopic-editor-container");
  const studySessionContainer = document.getElementById("study-session-container");

  const usernameInput = document.getElementById("username");
  const passwordInput = document.getElementById("password");
  const submitBtn = document.getElementById("submit-btn");
  const toggleAuth = document.getElementById("toggle-auth");

  const welcomeMsg = document.getElementById("welcome-msg");
  const logoutBtn = document.getElementById("logout-btn");
  const deleteAccountBtn = document.getElementById("delete-account-btn");

  const adminWelcomeMsg = document.getElementById("admin-welcome-msg");
  const adminLogoutBtn = document.getElementById("admin-logout-btn");

  const roleSearchInput = document.getElementById("role-search");
  const autocompleteList = document.getElementById("autocomplete-list");
  const personalRoleList = document.getElementById("personal-role-list");

  const masterRolesList = document.getElementById("master-roles-list");
  const newRoleTitleInput = document.getElementById("new-role-title");
  const newRoleDescInput = document.getElementById("new-role-desc");
  const addMasterRoleBtn = document.getElementById("add-master-role-btn");

  const formTitle = document.getElementById("form-title");

  const roleDetailTitle = document.getElementById("role-detail-title");
  const roleDetailDesc = document.getElementById("role-detail-desc");
  const backToRolesBtn = document.getElementById("back-to-roles-btn");
  const roleTopicsList = document.getElementById("role-topics-list");
  const roleProgressBar = document.getElementById("role-progress-bar");
  const roleProgressPercent = document.getElementById("role-progress-percent");

  const adminUserList = document.getElementById("admin-user-list");

  const adminTopicList = document.getElementById("admin-topic-list");
  const topicRoleTitle = document.getElementById("topic-role-title");
  const backToTopicsBtn = document.getElementById("back-to-topics-btn");
  const newTopicTitle = document.getElementById("new-topic-title");
  const newTopicStatus = document.getElementById("new-topic-status");
  const newTopicDeadline = document.getElementById("new-topic-deadline");
  const newTopicDesc = document.getElementById("new-topic-desc");
  const addTopicBtn = document.getElementById("add-topic-btn");

  const adminSubtopicList = document.getElementById("admin-subtopic-list");
  const subtopicTopicTitle = document.getElementById("subtopic-topic-title");
  const backToSubtopicsBtn = document.getElementById("back-to-subtopics-btn");
  const newSubtopicTitle = document.getElementById("new-subtopic-title");
  const newSubtopicStatus = document.getElementById("new-subtopic-status");
  const newSubtopicDeadline = document.getElementById("new-subtopic-deadline");
  const newSubtopicDesc = document.getElementById("new-subtopic-desc");
  const addSubtopicBtn = document.getElementById("add-subtopic-btn");

  const studySessionSubtopicTitle = document.getElementById("session-subtopic-title");
  const userStudySessionsList = document.getElementById("user-study-sessions-list");
  const sessionStartInput = document.getElementById("session-start");
  const sessionEndInput = document.getElementById("session-end");
  const sessionNotesInput = document.getElementById("session-notes");
  const addSessionBtn = document.getElementById("add-session-btn");
  const backToSubtopicsFromSessionsBtn = document.getElementById("back-to-subtopics-from-session-btn");

  //-- Event listeners and logic --

  toggleAuth.addEventListener("click", () => {
    isLogin = !isLogin;
    formTitle.textContent = isLogin ? "Login" : "Sign Up";
    submitBtn.textContent = isLogin ? "Login" : "Sign Up";
    toggleAuth.textContent = isLogin ? "Don't have an account? Sign up" : "Already have an account? Login";
    usernameInput.value = "";
    passwordInput.value = "";
  });

  submitBtn.addEventListener("click", () => {
    const username = usernameInput.value.trim();
    const password = passwordInput.value.trim();
    if (!username || !password) {
      alert("Enter username and password");
      return;
    }
    if (isLogin) {
      if (users[username] && users[username].password === hashPassword(password)) {
        currentUser = username;
        sessionStorage.setItem("currentUser", currentUser);
        showAppropriateDashboard();
      } else {
        alert("Invalid username or password");
      }
    } else {
      if (users[username]) {
        alert("Username already exists");
        return;
      }
      users[username] = { password: hashPassword(password), data: { roles: [] } };
      saveUsers();
      alert("User created! Please login.");
      isLogin = true;
      formTitle.textContent = "Login";
      submitBtn.textContent = "Login";
      toggleAuth.textContent = "Don't have an account? Sign up";
      usernameInput.value = "";
      passwordInput.value = "";
    }
  });

  function showAppropriateDashboard() {
    authContainer.classList.add("hidden");
    roleDetailsContainer.classList.add("hidden");
    topicEditorContainer.classList.add("hidden");
    subtopicEditorContainer.classList.add("hidden");
    studySessionContainer.classList.add("hidden");
    if (currentUser === ADMIN_USERNAME) {
      showAdminDashboard();
    } else {
      showUserDashboard();
    }
  }

  // Admin dash
  function showAdminDashboard() {
    userContainer.classList.add("hidden");
    adminContainer.classList.remove("hidden");
    adminWelcomeMsg.textContent = `Welcome, Admin!`;
    renderMasterRoles();
    renderAdminUsers();
  }

  // User dash
  function showUserDashboard() {
    adminContainer.classList.add("hidden");
    userContainer.classList.remove("hidden");
    welcomeMsg.textContent = `Welcome, ${currentUser}!`;
    roleSearchInput.value = "";
    renderPersonalRoles();
    autocompleteList.innerHTML = "";
  }

  logoutBtn.addEventListener("click", () => {
    currentUser = null;
    sessionStorage.removeItem("currentUser");
    userContainer.classList.add("hidden");
    roleDetailsContainer.classList.add("hidden");
    topicEditorContainer.classList.add("hidden");
    subtopicEditorContainer.classList.add("hidden");
    studySessionContainer.classList.add("hidden");
    authContainer.classList.remove("hidden");
    usernameInput.value = "";
    passwordInput.value = "";
  });

  adminLogoutBtn.addEventListener("click", () => {
    currentUser = null;
    sessionStorage.removeItem("currentUser");
    adminContainer.classList.add("hidden");
    authContainer.classList.remove("hidden");
    usernameInput.value = "";
    passwordInput.value = "";
  });

  deleteAccountBtn.addEventListener("click", () => {
    if (confirm("Delete your account? This cannot be undone.")) {
      delete users[currentUser];
      saveUsers();
      logoutBtn.click();
      alert("Account deleted");
    }
  });

  //-- Admin user management begin --
  function renderAdminUsers() {
    adminUserList.innerHTML = "";
    Object.keys(users).forEach(user => {
      const div = document.createElement("div");
      div.style.border = "1px solid #ddd";
      div.style.padding = "8px";
      div.style.marginBottom = "8px";
      div.style.borderRadius = "8px";
      div.style.display = "flex";
      div.style.justifyContent = "space-between";
      div.style.alignItems = "center";

      const text = document.createElement("span");
      text.textContent = user;
      div.appendChild(text);

      if (user !== ADMIN_USERNAME) {
        const delBtn = document.createElement("button");
        delBtn.textContent = "Delete User";
        delBtn.style.background = "#e53935";
        delBtn.style.color = "white";
        delBtn.style.border = "none";
        delBtn.style.padding = "4px 10px";
        delBtn.style.cursor = "pointer";
        delBtn.style.borderRadius = "6px";
        delBtn.onclick = () => {
          if (confirm(`Delete user: ${user}?`)) {
            delete users[user];
            saveUsers();
            renderAdminUsers();
          }
        };
        div.appendChild(delBtn);
      }

      adminUserList.appendChild(div);
    });
  }
  //-- Admin user management end --

  //-- Master roles begin --
  function renderMasterRoles() {
    masterRolesList.innerHTML = "";
    masterRoles.forEach((role, idx) => {
      const div = document.createElement("div");
      div.style.border = "1px solid #ddd";
      div.style.padding = "10px";
      div.style.marginBottom = "10px";
      div.style.borderRadius = "8px";

      const title = document.createElement("h4");
      title.textContent = role.title;
      div.appendChild(title);

      const desc = document.createElement("p");
      desc.textContent = role.description || "";
      div.appendChild(desc);

      const editBtn = document.createElement("button");
      editBtn.textContent = "Edit Topics";
      editBtn.style.background = "#2563eb";
      editBtn.style.color = "white";
      editBtn.style.border = "none";
      editBtn.style.padding = "6px 12px";
      editBtn.style.borderRadius = "6px";
      editBtn.style.cursor = "pointer";
      editBtn.style.marginRight = "10px";
      editBtn.onclick = () => {
        openTopicEditor(idx);
      };

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "Delete Role";
      deleteBtn.style.background = "#e53935";
      deleteBtn.style.color = "white";
      deleteBtn.style.border = "none";
      deleteBtn.style.padding = "6px 12px";
      deleteBtn.style.borderRadius = "6px";
      deleteBtn.style.cursor = "pointer";
      deleteBtn.onclick = () => {
        if (confirm(`Delete master role: ${role.title}?`)) {
          masterRoles.splice(idx, 1);
          saveMasterRoles();
          renderMasterRoles();
        }
      };

      div.appendChild(editBtn);
      div.appendChild(deleteBtn);

      masterRolesList.appendChild(div);
    });
  }

  addMasterRoleBtn.addEventListener("click", () => {
    const title = newRoleTitleInput.value.trim();
    const desc = newRoleDescInput.value.trim();
    if (!title) {
      alert("Role title is required");
      return;
    }
    if (masterRoles.some(r => r.title.toLowerCase() === title.toLowerCase())) {
      alert("Role already exists");
      return;
    }
    masterRoles.push({ id: `role-${Date.now()}`, title, description: desc, topics: [] });
    saveMasterRoles();
    newRoleTitleInput.value = "";
    newRoleDescInput.value = "";
    renderMasterRoles();
  });
  //-- Master roles end --

  //-- User roles begin --
  roleSearchInput.addEventListener("input", () => {
    const val = roleSearchInput.value.trim().toLowerCase();
    autocompleteList.innerHTML = "";
    if (!val) return;

    const filtered = masterRoles.filter(r => r.title.toLowerCase().includes(val));
    filtered.forEach(role => {
      const item = document.createElement("div");
      item.className = "role-item";
      item.textContent = role.title;

      const addBtn = document.createElement("button");
      addBtn.textContent = "Add";
      addBtn.className = "role-add-btn";
      addBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        addRoleToUser(role);
      });

      item.appendChild(addBtn);
      autocompleteList.appendChild(item);

      item.addEventListener("click", () => {
        roleSearchInput.value = role.title;
        autocompleteList.innerHTML = "";
      });
    });
  });

  function addRoleToUser(role) {
    const userData = users[currentUser].data;
    userData.roles = userData.roles || [];
    if (userData.roles.some(r => r.title === role.title)) {
      alert("Role already added");
      return;
    }
    userData.roles.push(JSON.parse(JSON.stringify(role))); // deep copy including topics
    saveUsers();
    alert(`Role "${role.title}" added to your list!`);
    renderPersonalRoles();
    roleSearchInput.value = "";
    autocompleteList.innerHTML = "";
  }

  function renderPersonalRoles() {
    const userData = users[currentUser].data;
    const roles = userData.roles || [];
    personalRoleList.innerHTML = "";
    if (roles.length === 0) {
      personalRoleList.innerHTML = "<p>No roles added yet. Use the search box above to add roles.</p>";
      return;
    }
    roles.forEach((role, i) => {
      const div = document.createElement("div");
      div.className = "personal-role";
      div.textContent = role.title;
      div.title = "Click to view role roadmap";
      div.tabIndex = 0;

      div.addEventListener("click", () => showRoleDetails(i));
      div.addEventListener("keypress", e => { if(e.key === "Enter") showRoleDetails(i); });

      const removeBtn = document.createElement("button");
      removeBtn.className = "remove-btn";
      removeBtn.title = `Remove ${role.title}`;
      removeBtn.textContent = "×";

      removeBtn.addEventListener("click", e => {
        e.stopPropagation();
        if(confirm(`Remove role "${role.title}"?`)) {
          roles.splice(i, 1);
          saveUsers();
          renderPersonalRoles();
          hideRoleDetails();
        }
      });

      div.appendChild(removeBtn);
      personalRoleList.appendChild(div);
    });
  }

  //-- Role details for user --
  function showRoleDetails(index) {
    selectedRoleIndex = index;
    const role = users[currentUser].data.roles[index];
    roleDetailTitle.textContent = role.title;
    roleDetailDesc.textContent = role.description || "No description provided.";
    renderRoleTopics(role.topics || []);
    updateRoleProgress(role.topics || []);
    userContainer.classList.add("hidden");
    roleDetailsContainer.classList.remove("hidden");
  }

  function renderRoleTopics(topics) {
    roleTopicsList.innerHTML = "";
    if (!topics.length) {
      roleTopicsList.innerHTML = "<li>No topics defined for this role.</li>";
      return;
    }
    topics.forEach(topic => {
      const li = document.createElement("li");
      li.className = "topic-item";
      const titleSpan = document.createElement("span");
      titleSpan.textContent = topic.title;

      // Status label
      const statusLabel = document.createElement("span");
      statusLabel.textContent = topic.status || "Pending";
      statusLabel.className = "status-label " + (topic.status ? "status-" + topic.status.toLowerCase().replace(/ /g, "") : "");
      statusLabel.style.marginLeft = "10px";

      li.appendChild(titleSpan);
      li.appendChild(statusLabel);
      roleTopicsList.appendChild(li);
    });
  }

  function updateRoleProgress(topics) {
    if (!topics.length) {
      roleProgressBar.style.width = "0%";
      roleProgressPercent.textContent = "";
      return;
    }
    const total = topics.length;
    const finishedCount = topics.filter(t => t.status && t.status.toLowerCase() === "finished").length;
    const percent = Math.round((finishedCount / total) * 100);
    roleProgressBar.style.width = percent + "%";
    roleProgressPercent.textContent = `Progress: ${percent}% completed`;
  }

  function hideRoleDetails() {
    roleDetailsContainer.classList.add("hidden");
    userContainer.classList.remove("hidden");
    selectedRoleIndex = null;
  }

  backToRolesBtn.addEventListener("click", hideRoleDetails);

  //-- Topic editor for admin --
  let editingRoleIndex = null;

  function openTopicEditor(roleIdx) {
    editingRoleIndex = roleIdx;
    adminContainer.classList.add("hidden");
    topicEditorContainer.classList.remove("hidden");

    const role = masterRoles[roleIdx];
    topicRoleTitle.textContent = role.title;
    renderAdminTopics(role.topics || []);
  }

  backToTopicsBtn.addEventListener("click", () => {
    topicEditorContainer.classList.add("hidden");
    adminContainer.classList.remove("hidden");
    editingRoleIndex = null;
  });

  function renderAdminTopics(topics) {
    adminTopicList.innerHTML = "";
    if (!topics.length) {
      adminTopicList.innerHTML = "<li>No topics yet</li>";
      return;
    }
    topics.forEach((topic, idx) => {
      const li = document.createElement("li");
      li.className = "topic-item";
      li.textContent = topic.title + " (" + (topic.status || "Pending") +")";

      const editBtn = document.createElement("button");
      editBtn.textContent = "Edit Subtopics";
      editBtn.style.marginLeft = "10px";
      editBtn.style.background = "#2563eb";
      editBtn.style.color = "white";
      editBtn.style.border = "none";
      editBtn.style.cursor = "pointer";
      editBtn.style.borderRadius = "6px";
      editBtn.onclick = () => openSubtopicEditor(idx);

      const delBtn = document.createElement("button");
      delBtn.textContent = "Delete";
      delBtn.style.marginLeft = "10px";
      delBtn.style.background = "#e53935";
      delBtn.style.color = "white";
      delBtn.style.border = "none";
      delBtn.style.cursor = "pointer";
      delBtn.style.borderRadius = "6px";
      delBtn.onclick = () => {
        if(confirm('Delete topic "' + topic.title + '"?')) {
          masterRoles[editingRoleIndex].topics.splice(idx, 1);
          saveMasterRoles();
          renderAdminTopics(masterRoles[editingRoleIndex].topics);
        }
      };

      li.appendChild(editBtn);
      li.appendChild(delBtn);

      adminTopicList.appendChild(li);
    });
  }

  addTopicBtn.addEventListener("click", () => {
    const title = newTopicTitle.value.trim();
    const status = newTopicStatus.value;
    const deadline = newTopicDeadline.value;
    const desc = newTopicDesc.value.trim();
    if (!title) {
      alert("Topic title required");
      return;
    }
    let newTopic = { title, status, deadline, description: desc, subtopics: [] };
    masterRoles[editingRoleIndex].topics = masterRoles[editingRoleIndex].topics || [];
    masterRoles[editingRoleIndex].topics.push(newTopic);
    saveMasterRoles();
    renderAdminTopics(masterRoles[editingRoleIndex].topics);
    newTopicTitle.value = "";
    newTopicStatus.value = "Pending";
    newTopicDeadline.value = "";
    newTopicDesc.value = "";
  });

  //-- Subtopic editor for admin --
  let editingTopicIndex = null;

  function openSubtopicEditor(topicIdx) {
    editingTopicIndex = topicIdx;
    topicEditorContainer.classList.add("hidden");
    subtopicEditorContainer.classList.remove("hidden");

    const topic = masterRoles[editingRoleIndex].topics[topicIdx];
    subtopicTopicTitle.textContent = topic.title;
    renderAdminSubtopics(topic.subtopics || []);
  }

  backToSubtopicsBtn.addEventListener("click", () => {
    subtopicEditorContainer.classList.add("hidden");
    topicEditorContainer.classList.remove("hidden");
    editingTopicIndex = null;
  });

  function renderAdminSubtopics(subtopics) {
    adminSubtopicList.innerHTML = "";
    if (!subtopics.length) {
      adminSubtopicList.innerHTML = "<li>No subtopics yet</li>";
      return;
    }
    subtopics.forEach((subtopic, idx) => {
      const li = document.createElement("li");
      li.className = "subtopic-item";
      li.textContent = subtopic.title + " (" + (subtopic.status || "Pending") + ")";

      const delBtn = document.createElement("button");
      delBtn.textContent = "Delete";
      delBtn.style.marginLeft = "10px";
      delBtn.style.background = "#e53935";
      delBtn.style.color = "white";
      delBtn.style.border = "none";
      delBtn.style.cursor = "pointer";
      delBtn.style.borderRadius = "6px";
      delBtn.onclick = () => {
        if(confirm('Delete subtopic "' + subtopic.title + '"?')) {
          masterRoles[editingRoleIndex].topics[editingTopicIndex].subtopics.splice(idx, 1);
          saveMasterRoles();
          renderAdminSubtopics(masterRoles[editingRoleIndex].topics[editingTopicIndex].subtopics);
        }
      };
      li.appendChild(delBtn);
      adminSubtopicList.appendChild(li);
    });
  }

  addSubtopicBtn.addEventListener("click", () => {
    const title = newSubtopicTitle.value.trim();
    const status = newSubtopicStatus.value;
    const deadline = newSubtopicDeadline.value;
    const desc = newSubtopicDesc.value.trim();
    if (!title) {
      alert("Subtopic title required");
      return;
    }
    let newSubtopic = { title, status, deadline, description: desc };
    let subs = masterRoles[editingRoleIndex].topics[editingTopicIndex].subtopics || [];
    subs.push(newSubtopic);
    masterRoles[editingRoleIndex].topics[editingTopicIndex].subtopics = subs;
    saveMasterRoles();
    renderAdminSubtopics(subs);
    newSubtopicTitle.value = "";
    newSubtopicStatus.value = "Pending";
    newSubtopicDeadline.value = "";
    newSubtopicDesc.value = "";
  });

  //-- Study session management for user --
  let currentRoleIdx = null;
  let currentTopicIdx = null;
  let currentSubtopicIdx = null;

  function showStudySessions(roleIdx, topicIdx, subtopicIdx) {
    currentRoleIdx = roleIdx;
    currentTopicIdx = topicIdx;
    currentSubtopicIdx = subtopicIdx;

    let subtopic = users[currentUser].data.roles[roleIdx].topics[topicIdx].subtopics[subtopicIdx];
    studySessionSubtopicTitle.textContent = subtopic.title;
    userStudySessionsList.innerHTML = "";

    subtopic.sessions = subtopic.sessions || [];

    if(subtopic.sessions.length === 0) {
      userStudySessionsList.innerHTML = "<li>No study sessions logged.</li>";
    } else {
      subtopic.sessions.forEach((s,i) => {
        let li = document.createElement("li");
        li.textContent = `Start: ${formatDate(s.start)} - End: ${formatDate(s.end)} Notes: ${s.notes || "(none)"}`;
        userStudySessionsList.appendChild(li);
      });
    }

    userContainer.classList.add("hidden");
    roleDetailsContainer.classList.add("hidden");
    topicEditorContainer.classList.add("hidden");
    subtopicEditorContainer.classList.add("hidden");
    studySessionContainer.classList.remove("hidden");
  }

  backToSubtopicsFromSessionsBtn.addEventListener("click", () => {
    studySessionContainer.classList.add("hidden");
    showRoleDetails(currentRoleIdx);
  });

  addSessionBtn.addEventListener("click", () => {
    let start = sessionStartInput.value;
    let end = sessionEndInput.value;
    let notes = sessionNotesInput.value.trim();
    if(!start || !end) {
      alert("Please provide start and end date/time");
      return;
    }
    if(new Date(start) > new Date(end)) {
      alert("End date/time must be after start date/time");
      return;
    }
    let subtopic = users[currentUser].data.roles[currentRoleIdx].topics[currentTopicIdx].subtopics[currentSubtopicIdx];
    subtopic.sessions = subtopic.sessions || [];
    subtopic.sessions.push({start, end, notes});
    saveUsers();
    alert("Study session added!");
    sessionStartInput.value = "";
    sessionEndInput.value = "";
    sessionNotesInput.value = "";
    showStudySessions(currentRoleIdx, currentTopicIdx, currentSubtopicIdx);
  });

  //-- Demo starter data --
  if(!masterRoles.length){
    masterRoles = [
      { id: "devops", title: "DevOps Engineer", description: "Role covering Azure, AWS, Terraform.", topics: [
          { title: "Azure Core", status: "Pending", subtopics: [] },
          { title: "Terraform IaC", status: "Pending", subtopics: [] }
        ]},
      { id: "infrastructure", title: "Infrastructure Engineer", description: "Server and virtualization basics.", topics: []},
      { id: "noc", title: "NOC Engineer", description: "Monitoring and incident handling.", topics: [] }
    ];
    saveMasterRoles();
  }

  //-- User role detail clickable to show topic and subtopic navigation can be built incrementally when desired --

  //-- Role progress, topic status, and user note editing UI can be added as next upgrades --

  //-- Login session restore --
  window.onload = () => {
    const savedUser = sessionStorage.getItem("currentUser");
    if(savedUser && users[savedUser]) {
      currentUser = savedUser;
      showAppropriateDashboard();
    }
  };
</script>
</body>
</html>
